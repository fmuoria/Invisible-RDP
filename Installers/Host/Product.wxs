<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
  
  <Package Name="InvisibleRDP Host" 
           Manufacturer="InvisibleRDP"
           Version="1.0.0.0"
           UpgradeCode="12345678-1234-1234-1234-123456789ABC"
           InstallerVersion="500"
           Compressed="yes">
    
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <!-- UI -->
    <ui:WixUI Id="WixUI_Minimal" />
    <UIRef Id="WixUI_ErrorProgressText" />
    
    <!-- Custom consent dialog (WiX4 compliant) -->
    <CustomAction Id="ShowConsentDialog" 
                  BinaryRef="CustomActions" 
                  DllEntry="ShowConsent" 
                  Execute="immediate" 
                  Return="check" />

    <!-- Install sequence, WiX v4 format -->
    <InstallExecuteSequence>
      <Custom Action="ShowConsentDialog" Before="InstallFiles">NOT Installed</Custom>
    </InstallExecuteSequence>
    
  </Package>

  <!-- User consent property and condition (move outside of <Package> as WiX4 does not support <Condition> here) -->
  <Property Id="USER_CONSENT" Value="0" />
  <Condition Message="User consent is required to install InvisibleRDP Host.">
    USER_CONSENT = "1" OR Installed
  </Condition>

  <!-- Features -->
  <Fragment>
    <Feature Id="Complete" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="ServiceComponents" />
    </Feature>
  </Fragment>

  <!-- Directory structure: use StandardDirectory for WiX v4 -->
  <Fragment>
    <StandardDirectory Id="ProgramFilesFolder">
      <StandardDirectory Id="INSTALLFOLDER" Name="InvisibleRDP">
        <StandardDirectory Id="HostFolder" Name="Host" />
      </StandardDirectory>
    </StandardDirectory>
    <StandardDirectory Id="ProgramMenuFolder">
      <StandardDirectory Id="ApplicationProgramsFolder" Name="InvisibleRDP" />
    </StandardDirectory>
    <StandardDirectory Id="CommonAppDataFolder">
      <StandardDirectory Id="AppDataFolder" Name="InvisibleRDP" />
    </StandardDirectory>
  </Fragment>

  <!-- Components -->
  <Fragment>
    <ComponentGroup Id="ProductComponents" Directory="HostFolder">
      <Component Id="SystemTrayApp" Guid="11111111-1111-1111-1111-111111111111">
        <File Id="SystemTrayExe" 
              Source="..\..\InvisibleRDP.SystemTray\bin\Release\net8.0-windows\InvisibleRDP.SystemTray.exe"
              KeyPath="yes" />
        <Shortcut Id="SystemTrayStartup"
                  Directory="ApplicationProgramsFolder"
                  Name="InvisibleRDP Host"
                  Description="Remote Desktop Host Application"
                  WorkingDirectory="HostFolder"
                  Icon="AppIcon.exe"
                  IconIndex="0"
                  Advertise="yes" />
        
        <!-- Add to startup -->
        <RegistryValue Root="HKCU"
                       Key="Software\Microsoft\Windows\CurrentVersion\Run"
                       Name="InvisibleRDP"
                       Value="[HostFolder]InvisibleRDP.SystemTray.exe"
                       Type="string" />
      </Component>
      
      <Component Id="CoreLibrary" Guid="22222222-2222-2222-2222-222222222222">
        <File Source="..\..\InvisibleRDP.Core\bin\Release\net8.0\InvisibleRDP.Core.dll" />
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="ServiceComponents" Directory="HostFolder">
      <Component Id="ServiceExe" Guid="33333333-3333-3333-3333-333333333333">
        <File Id="ServiceFile"
              Source="..\..\InvisibleRDP.Service\bin\Release\net8.0\InvisibleRDP.Service.exe"
              KeyPath="yes" />
        
        <ServiceInstall Id="ServiceInstaller"
                        Type="ownProcess"
                        Name="SystemHostSvc"
                        DisplayName="InvisibleRDP Host Service"
                        Description="Remote Desktop Host Service with user consent"
                        Start="auto"
                        Account="LocalSystem"
                        ErrorControl="normal"
                        Interactive="no" />
        
        <ServiceControl Id="StartService"
                        Start="install"
                        Stop="both"
                        Remove="uninstall"
                        Name="SystemHostSvc"
                        Wait="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- Icon -->
  <Fragment>
    <Icon Id="AppIcon.exe" SourceFile="..\..\InvisibleRDP.SystemTray\bin\Release\net8.0-windows\InvisibleRDP.SystemTray.exe" />
  </Fragment>
</Wix>
